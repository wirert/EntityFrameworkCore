namespace ProductShop.Test
{
    //ReSharper disable InconsistentNaming, CheckNamespace

    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;
    using AutoMapper;
    using Microsoft.EntityFrameworkCore;
    using Microsoft.Extensions.DependencyInjection;
    using Newtonsoft.Json;
    using Newtonsoft.Json.Linq;
    using NUnit.Framework;
    using ProductShop;
    using ProductShop.Data;
    using ProductShop.Models;

    [TestFixture]
    public class Test_007_000_001
    {
        private IServiceProvider serviceProvider;

        private static readonly Assembly CurrentAssembly = typeof(StartUp).Assembly;

        [SetUp]
        public void Setup()
        {
            /*Mapper.Reset();
         Mapper.Initialize(cfg => cfg.AddProfile(GetType("ProductShopProfile")));*/

            var config = new MapperConfiguration(cfg =>
            {
                cfg.AddProfile<ProductShopProfile>();
            });

            this.serviceProvider = ConfigureServices<ProductShopContext>("ProductShop");
        }

        [Test]
        public void ExportCategoriesByProductsZeroTests()
        {
            var context = this.serviceProvider.GetService<ProductShopContext>();

            //SeedDatabase(context);

            var expectedOutputValue = "[{\"category\":\"Garden\",\"productsCount\":23,\"averagePrice\":800.15,\"totalRevenue\":18403.47},{\"category\":\"Drugs\",\"productsCount\":22,\"averagePrice\":882.2,\"totalRevenue\":19408.43},{\"category\":\"Adult\",\"productsCount\":22,\"averagePrice\":775.59,\"totalRevenue\":17062.92},{\"category\":\"Weapons\",\"productsCount\":22,\"averagePrice\":671.07,\"totalRevenue\":14763.61},{\"category\":\"Other\",\"productsCount\":19,\"averagePrice\":765.35,\"totalRevenue\":14541.71},{\"category\":\"Autoparts\",\"productsCount\":17,\"averagePrice\":761.73,\"totalRevenue\":12949.33},{\"category\":\"Business\",\"productsCount\":17,\"averagePrice\":823.3,\"totalRevenue\":13996.15},{\"category\":\"Fashion\",\"productsCount\":16,\"averagePrice\":780.98,\"totalRevenue\":12495.63},{\"category\":\"Electronics\",\"productsCount\":14,\"averagePrice\":737.92,\"totalRevenue\":10330.86},{\"category\":\"For Children\",\"productsCount\":14,\"averagePrice\":685.15,\"totalRevenue\":9592.08},{\"category\":\"Sports\",\"productsCount\":14,\"averagePrice\":750.64,\"totalRevenue\":10508.98}]\r\n ";
            var expectedOutput = JToken.Parse(expectedOutputValue);
            var actualOutputValue = StartUp.GetCategoriesByProductsCount(context);
            var actualOutput = JToken.Parse(actualOutputValue);

            var expected = expectedOutput.ToString(Formatting.None);
            var actual = actualOutput.ToString(Formatting.None);

            Assert.That(actual, Is.EqualTo(expected).NoClip,
                $"{nameof(StartUp.GetCategoriesByProductsCount)} output is incorrect!");
        }

        private static void SeedDatabase(ProductShopContext context)
        {
            var productsJson =
                @"[{""Name"":""Care One Hemorrhoidal"",""Price"":932.18,""SellerId"":25,""BuyerId"":24},{""Name"":""SNORING HP"",""Price"":53.59,""SellerId"":24,""BuyerId"":30},{""Name"":""ROPINIROLE HYDROCHLORIDE"",""Price"":266.44,""SellerId"":33,""BuyerId"":16},{""Name"":""kirkland signature minoxidil"",""Price"":49.17,""SellerId"":38,""BuyerId"":39},{""Name"":""Agaricus Equisetum Special Order"",""Price"":585.93,""SellerId"":22,""BuyerId"":27},{""Name"":""Lamotrigine Extended Release"",""Price"":245.63,""SellerId"":39,""BuyerId"":38},{""Name"":""CLARINS Ever Matte SPF 15 - 105 Nude"",""Price"":696.06,""SellerId"":39,""BuyerId"":56},{""Name"":""Childrens Allegra Allergy"",""Price"":650.97,""SellerId"":15,""BuyerId"":36},{""Name"":""PredniSONE"",""Price"":286.43,""SellerId"":31,""BuyerId"":32},{""Name"":""Spironolactone"",""Price"":933.69,""SellerId"":44,""BuyerId"":null},{""Name"":""U-max Multi BB"",""Price"":137.16,""SellerId"":20,""BuyerId"":35},{""Name"":""Phenylephrine HCl"",""Price"":459.89,""SellerId"":24,""BuyerId"":53},{""Name"":""Finasteride"",""Price"":1374.01,""SellerId"":16,""BuyerId"":55},{""Name"":""Clarins Paris Skin Illusion - 114 cappuccino"",""Price"":811.42,""SellerId"":28,""BuyerId"":12},{""Name"":""Enalapril Maleate"",""Price"":72.71,""SellerId"":53,""BuyerId"":24},{""Name"":""MEDICATED DANDRUFF"",""Price"":1351.02,""SellerId"":29,""BuyerId"":42},{""Name"":""Pleo Lat"",""Price"":720.08,""SellerId"":7,""BuyerId"":50},{""Name"":""Myristica Argentum Sinus Relief"",""Price"":904.52,""SellerId"":30,""BuyerId"":47},{""Name"":""Glyburide"",""Price"":95.1,""SellerId"":16,""BuyerId"":18},{""Name"":""Burn Jel"",""Price"":209.57,""SellerId"":34,""BuyerId"":null},{""Name"":""CHAMOMILLA"",""Price"":37.97,""SellerId"":5,""BuyerId"":48},{""Name"":""NEO-POLY-BAC HYDRO"",""Price"":967.32,""SellerId"":38,""BuyerId"":48},{""Name"":""Prednisone"",""Price"":550.72,""SellerId"":26,""BuyerId"":44},{""Name"":""Isosorbide Mononitrate"",""Price"":789.91,""SellerId"":25,""BuyerId"":10},{""Name"":""Glipizide and Metformin Hydrochloride"",""Price"":953.6,""SellerId"":50,""BuyerId"":41},{""Name"":""TERSI"",""Price"":554.91,""SellerId"":12,""BuyerId"":1},{""Name"":""SEPHORA Acne-Fighting Mattifying Moisturizer"",""Price"":1019.28,""SellerId"":6,""BuyerId"":31},{""Name"":""Smooth texture Orange flavor"",""Price"":976.65,""SellerId"":41,""BuyerId"":12},{""Name"":""DAYWEAR PLUS MULTI PROTECTION TINTED MOISTURIZER"",""Price"":555.12,""SellerId"":55,""BuyerId"":19},{""Name"":""Zonisamide"",""Price"":1305.41,""SellerId"":29,""BuyerId"":null},{""Name"":""Peter Island Continous sunscreen kids"",""Price"":471.3,""SellerId"":27,""BuyerId"":39},{""Name"":""GOONG SECRET CALMING BATH"",""Price"":742.47,""SellerId"":16,""BuyerId"":30},{""Name"":""Clearskin"",""Price"":968.59,""SellerId"":11,""BuyerId"":9},{""Name"":""No7 Protect and Perfect Foundation Sunscreen Broad Spectrum SPF 15 Cool Ivory"",""Price"":616.19,""SellerId"":5,""BuyerId"":55},{""Name"":""Alcohol Free Antiseptic"",""Price"":1486.07,""SellerId"":39,""BuyerId"":26},{""Name"":""smart sense nighttime cold and flu relief"",""Price"":1101.77,""SellerId"":9,""BuyerId"":13},{""Name"":""Warfarin Sodium"",""Price"":1379.79,""SellerId"":39,""BuyerId"":17},{""Name"":""Oxygen"",""Price"":1242.92,""SellerId"":13,""BuyerId"":14},{""Name"":""Amlodipine Besylate"",""Price"":122.57,""SellerId"":15,""BuyerId"":4},{""Name"":""CVS Therapeutic Menthol Pain Reliever"",""Price"":1033.42,""SellerId"":4,""BuyerId"":null},{""Name"":""Warfarin Sodium"",""Price"":770.05,""SellerId"":24,""BuyerId"":29},{""Name"":""Gilotrif"",""Price"":1454.77,""SellerId"":15,""BuyerId"":47},{""Name"":""Shopko Lip Treatment"",""Price"":861.42,""SellerId"":29,""BuyerId"":40},{""Name"":""Albuterol"",""Price"":108.95,""SellerId"":47,""BuyerId"":45},{""Name"":""Eszopiclone"",""Price"":405.03,""SellerId"":3,""BuyerId"":56},{""Name"":""EMEND"",""Price"":1365.51,""SellerId"":16,""BuyerId"":36},{""Name"":""Etomidate"",""Price"":393.94,""SellerId"":6,""BuyerId"":40},{""Name"":""Megestrol Acetate"",""Price"":976.15,""SellerId"":50,""BuyerId"":28},{""Name"":""Head and Shoulders Conditioner"",""Price"":1099.59,""SellerId"":13,""BuyerId"":36},{""Name"":""ERYTHROMYCIN Base Filmtab"",""Price"":117.84,""SellerId"":39,""BuyerId"":null},{""Name"":""Flumazenil"",""Price"":1151.37,""SellerId"":22,""BuyerId"":27},{""Name"":""LANEIGE MYSTIC VEIL FOUNDATION"",""Price"":20.86,""SellerId"":43,""BuyerId"":28},{""Name"":""EPZICOM"",""Price"":895.65,""SellerId"":34,""BuyerId"":35},{""Name"":""Almond"",""Price"":367.32,""SellerId"":33,""BuyerId"":9},{""Name"":""Etoposide"",""Price"":1483.96,""SellerId"":41,""BuyerId"":27},{""Name"":""ESIKA 3-IN-1 PRO MAKE UP FOUNDATION SPF 20 BASE DE MAQUILLAJE PARA ROSTRO 3-EN-1 PRO FPS 20"",""Price"":1097.6,""SellerId"":46,""BuyerId"":10},{""Name"":""Levothyroxine Sodium"",""Price"":885.86,""SellerId"":48,""BuyerId"":15},{""Name"":""Dawn Ultra Antibacterial Hand"",""Price"":969.86,""SellerId"":56,""BuyerId"":51},{""Name"":""cough and sore throat"",""Price"":1482.68,""SellerId"":9,""BuyerId"":11},{""Name"":""Moore Medical Sinus Pain and Pressure Relief"",""Price"":855.39,""SellerId"":43,""BuyerId"":null},{""Name"":""Glipizide"",""Price"":621.78,""SellerId"":4,""BuyerId"":1},{""Name"":""Fosphenytoin Sodium"",""Price"":1334.06,""SellerId"":37,""BuyerId"":25},{""Name"":""ENALAPRIL MALEATE"",""Price"":210.42,""SellerId"":51,""BuyerId"":14},{""Name"":""LV-FX"",""Price"":820.87,""SellerId"":48,""BuyerId"":40},{""Name"":""Wintergreen Isopropyl Alcohol"",""Price"":1397.57,""SellerId"":8,""BuyerId"":26},{""Name"":""ORCHID SECRET PACT"",""Price"":59.53,""SellerId"":42,""BuyerId"":19},{""Name"":""Metaxalone"",""Price"":79.94,""SellerId"":6,""BuyerId"":19},{""Name"":""Allergena"",""Price"":109.32,""SellerId"":16,""BuyerId"":38},{""Name"":""XANTHIUM STRUMARIUM VAR CANADENSE POLLEN"",""Price"":1091.38,""SellerId"":54,""BuyerId"":35},{""Name"":""Ampicillin"",""Price"":674.63,""SellerId"":49,""BuyerId"":null},{""Name"":""Buprenorphine hydrochloride and naloxone hydrochloride dihydrate"",""Price"":293.33,""SellerId"":45,""BuyerId"":18},{""Name"":""Acnezzol Base"",""Price"":710.6,""SellerId"":51,""BuyerId"":46},{""Name"":""AMARANTHUS PALMERI POLLEN"",""Price"":623.16,""SellerId"":28,""BuyerId"":32},{""Name"":""PANTOPRAZOLE SODIUM"",""Price"":293.89,""SellerId"":25,""BuyerId"":40},{""Name"":""Cold and Cough"",""Price"":218.14,""SellerId"":4,""BuyerId"":43},{""Name"":""Metformin Hydrochloride"",""Price"":953.99,""SellerId"":35,""BuyerId"":12},{""Name"":""LBEL Couleur Luxe Rouge Amplifier XP amplifying SPF 15"",""Price"":1069.43,""SellerId"":7,""BuyerId"":6},{""Name"":""Diastat"",""Price"":614.14,""SellerId"":32,""BuyerId"":3},{""Name"":""Topical 60 Sec Sodium Fluoride"",""Price"":1228.84,""SellerId"":17,""BuyerId"":4},{""Name"":""TRAMADOL HYDROCHLORIDE"",""Price"":516.48,""SellerId"":28,""BuyerId"":null},{""Name"":""Fexofenadine HCl and Pseudoephedrine HCI"",""Price"":73.07,""SellerId"":42,""BuyerId"":1},{""Name"":""equaline"",""Price"":520.45,""SellerId"":26,""BuyerId"":11},{""Name"":""Leg Cramp Relief"",""Price"":1345.69,""SellerId"":46,""BuyerId"":15},{""Name"":""CD CAPTURE TOTALE Triple Correcting Serum Foundation Wrinkles-Dark Spots-Radiance with sunscreen Broad Spectrum SPF 25 010"",""Price"":77.23,""SellerId"":40,""BuyerId"":4},{""Name"":""PRIMAXIN"",""Price"":686.66,""SellerId"":9,""BuyerId"":22},{""Name"":""H-Rosacea Formula"",""Price"":99.74,""SellerId"":54,""BuyerId"":49},{""Name"":""Benazepril Hydrochloride and Hydrochlorothiazide"",""Price"":1187.27,""SellerId"":5,""BuyerId"":22},{""Name"":""Leflunomide"",""Price"":312.85,""SellerId"":53,""BuyerId"":4},{""Name"":""BareMinerals Golden Tan matte"",""Price"":110.93,""SellerId"":15,""BuyerId"":46},{""Name"":""CEDAX"",""Price"":342.86,""SellerId"":27,""BuyerId"":null},{""Name"":""Topex"",""Price"":1258.49,""SellerId"":1,""BuyerId"":10},{""Name"":""DIVALPROEX SODIUM"",""Price"":1287.03,""SellerId"":7,""BuyerId"":40},{""Name"":""Acetic Acid"",""Price"":1060.43,""SellerId"":26,""BuyerId"":35},{""Name"":""MEDI-FIRST Non-Aspirin"",""Price"":1301.28,""SellerId"":53,""BuyerId"":52},{""Name"":""Lorazepam"",""Price"":1134.96,""SellerId"":47,""BuyerId"":10},{""Name"":""Alternaria alternata"",""Price"":61.24,""SellerId"":52,""BuyerId"":35},{""Name"":""Budpak Hemorrhoid Anesthetic"",""Price"":1499.29,""SellerId"":48,""BuyerId"":56},{""Name"":""Ringers"",""Price"":1054.37,""SellerId"":22,""BuyerId"":30},{""Name"":""Allopurinol"",""Price"":518.5,""SellerId"":33,""BuyerId"":25},{""Name"":""REYATAZ"",""Price"":41.97,""SellerId"":42,""BuyerId"":null},{""Name"":""Carbon Dioxide Oxygen Mixture"",""Price"":95.49,""SellerId"":33,""BuyerId"":6},{""Name"":""IOPE RETIGEN MOISTURE TWIN CAKE NO.21"",""Price"":1257.71,""SellerId"":16,""BuyerId"":23},{""Name"":""MOIST MOISTURE SKIN TONER"",""Price"":152.43,""SellerId"":30,""BuyerId"":28},{""Name"":""Strattera"",""Price"":658.54,""SellerId"":49,""BuyerId"":27},{""Name"":""Aquafresh"",""Price"":849.93,""SellerId"":50,""BuyerId"":13},{""Name"":""Nighttime Sleep Aid"",""Price"":1217.11,""SellerId"":29,""BuyerId"":12},{""Name"":""Pollens - Weeds and Garden Plants, Nettle Urtica dioica"",""Price"":782.77,""SellerId"":19,""BuyerId"":13},{""Name"":""Perrigo Benzoyl Peroxide"",""Price"":873.24,""SellerId"":19,""BuyerId"":17},{""Name"":""ENBREL"",""Price"":673.97,""SellerId"":35,""BuyerId"":26},{""Name"":""Propranolol Hydrochloride"",""Price"":546.95,""SellerId"":27,""BuyerId"":null},{""Name"":""Allopurinol"",""Price"":48.8,""SellerId"":3,""BuyerId"":30},{""Name"":""Trihexyphenidyl Hydrochloride"",""Price"":64.88,""SellerId"":54,""BuyerId"":40},{""Name"":""Archangelica Eucalyptus"",""Price"":1334.91,""SellerId"":12,""BuyerId"":4},{""Name"":""Effervescent Cold Relief"",""Price"":1436.07,""SellerId"":42,""BuyerId"":46},{""Name"":""Allopurinol"",""Price"":336.81,""SellerId"":41,""BuyerId"":9},{""Name"":""Parsley"",""Price"":519.06,""SellerId"":12,""BuyerId"":32},{""Name"":""Protonix"",""Price"":466.7,""SellerId"":45,""BuyerId"":13},{""Name"":""Pollens - Trees, Birch Mix"",""Price"":1153.54,""SellerId"":9,""BuyerId"":36},{""Name"":""ropinirole hydrochloride"",""Price"":103.58,""SellerId"":35,""BuyerId"":25},{""Name"":""olio activ mouthwash"",""Price"":206.06,""SellerId"":51,""BuyerId"":null},{""Name"":""CARBIDOPA AND LEVODOPA"",""Price"":441.64,""SellerId"":27,""BuyerId"":11},{""Name"":""Pollens - Weeds and Garden Plants, Scotch Broom Cytisus scoparius"",""Price"":135.82,""SellerId"":43,""BuyerId"":20},{""Name"":""Azithromycin"",""Price"":813.87,""SellerId"":23,""BuyerId"":25},{""Name"":""Meloxicam"",""Price"":809.18,""SellerId"":1,""BuyerId"":21},{""Name"":""pain relief"",""Price"":938.23,""SellerId"":22,""BuyerId"":46},{""Name"":""GEMCITABINE"",""Price"":1468.11,""SellerId"":36,""BuyerId"":48},{""Name"":""Topiramate"",""Price"":578.77,""SellerId"":39,""BuyerId"":31},{""Name"":""Cefadroxil"",""Price"":1302.2,""SellerId"":37,""BuyerId"":44},{""Name"":""Warfarin Sodium"",""Price"":138.83,""SellerId"":50,""BuyerId"":18},{""Name"":""PAMO Kill Natural"",""Price"":1181.06,""SellerId"":52,""BuyerId"":null},{""Name"":""Fluoxetine"",""Price"":385.37,""SellerId"":27,""BuyerId"":44},{""Name"":""Gemcitabine"",""Price"":594.79,""SellerId"":42,""BuyerId"":38},{""Name"":""Aspen"",""Price"":1046.46,""SellerId"":8,""BuyerId"":46},{""Name"":""AIR"",""Price"":581.69,""SellerId"":44,""BuyerId"":24},{""Name"":""AVANDAMET"",""Price"":632.08,""SellerId"":24,""BuyerId"":51},{""Name"":""Fair Foundation SPF 15"",""Price"":1394.24,""SellerId"":16,""BuyerId"":29},{""Name"":""Pleo Ginkgo"",""Price"":613.65,""SellerId"":11,""BuyerId"":33},{""Name"":""Irbesartan and Hydrochlorothiazide"",""Price"":308.3,""SellerId"":28,""BuyerId"":19},{""Name"":""IOPE SUPER VITAL"",""Price"":824.68,""SellerId"":2,""BuyerId"":28},{""Name"":""Ibuprofen"",""Price"":1088.04,""SellerId"":44,""BuyerId"":null},{""Name"":""PREMIER VALUE ALLERGY"",""Price"":1127.61,""SellerId"":9,""BuyerId"":35},{""Name"":""Labetalol Hydrochloride"",""Price"":1345.11,""SellerId"":14,""BuyerId"":5},{""Name"":""Prednisone"",""Price"":1285.99,""SellerId"":34,""BuyerId"":55},{""Name"":""Growing Pains"",""Price"":1077.37,""SellerId"":17,""BuyerId"":7},{""Name"":""Extra Strength Pain Reliever PM"",""Price"":542.72,""SellerId"":27,""BuyerId"":2},{""Name"":""Americaine"",""Price"":1165.75,""SellerId"":14,""BuyerId"":25},{""Name"":""Echinacea Quartz Gum Support"",""Price"":570.08,""SellerId"":53,""BuyerId"":24},{""Name"":""SUMATRIPTAN SUCCINATE"",""Price"":1265.94,""SellerId"":25,""BuyerId"":2},{""Name"":""Amitiza"",""Price"":666.58,""SellerId"":19,""BuyerId"":25},{""Name"":""Goats Milk"",""Price"":298.53,""SellerId"":1,""BuyerId"":null},{""Name"":""Glycopyrrolate"",""Price"":1471.43,""SellerId"":17,""BuyerId"":40},{""Name"":""Ondansetron"",""Price"":1249.76,""SellerId"":8,""BuyerId"":26},{""Name"":""Baza Antifungal"",""Price"":1162.34,""SellerId"":17,""BuyerId"":51},{""Name"":""Imipramine Hydrochloride"",""Price"":648.69,""SellerId"":6,""BuyerId"":46},{""Name"":""Aspirin"",""Price"":925.45,""SellerId"":1,""BuyerId"":16},{""Name"":""Retin-A MICRO"",""Price"":995.98,""SellerId"":1,""BuyerId"":9},{""Name"":""VITALUMIERE AQUA"",""Price"":1293.09,""SellerId"":8,""BuyerId"":6},{""Name"":""Stila Hydrating Primer Oil-Free SPF 30"",""Price"":179.28,""SellerId"":20,""BuyerId"":33},{""Name"":""Enchanted Moments Mistletoe Kisses Hand Sanitizer"",""Price"":384.99,""SellerId"":54,""BuyerId"":22},{""Name"":""PCA SKIN ACNE"",""Price"":1356.22,""SellerId"":46,""BuyerId"":null},{""Name"":""CALMING DIAPER RASH"",""Price"":700.92,""SellerId"":14,""BuyerId"":23},{""Name"":""Labetalol hydrochloride"",""Price"":436.38,""SellerId"":38,""BuyerId"":7},{""Name"":""Ketorolac Tromethamine"",""Price"":608.18,""SellerId"":22,""BuyerId"":32},{""Name"":""Foaming Hand Sanitizer"",""Price"":624.72,""SellerId"":17,""BuyerId"":28},{""Name"":""Aspergillus repens"",""Price"":1231.42,""SellerId"":49,""BuyerId"":12},{""Name"":""ISOPROPYL ALCOHOL"",""Price"":339.48,""SellerId"":41,""BuyerId"":18},{""Name"":""XtraCare Foam Antibacterial Hand Wash"",""Price"":1251.97,""SellerId"":12,""BuyerId"":33},{""Name"":""smart sense nicotine"",""Price"":1444.12,""SellerId"":30,""BuyerId"":11},{""Name"":""up and up temporary minor arthritis pain relief"",""Price"":1085.78,""SellerId"":13,""BuyerId"":29},{""Name"":""RESCRIPTOR"",""Price"":850.52,""SellerId"":29,""BuyerId"":null},{""Name"":""Buprenorphine hydrochloride"",""Price"":391.05,""SellerId"":35,""BuyerId"":13},{""Name"":""PLANTAGO LANCEOLATA POLLEN"",""Price"":561.68,""SellerId"":47,""BuyerId"":53},{""Name"":""Gehwol med Lipidro"",""Price"":421.24,""SellerId"":42,""BuyerId"":46},{""Name"":""Triamterene and Hydrochlorothiazide"",""Price"":1416.59,""SellerId"":2,""BuyerId"":32},{""Name"":""Ranitidine"",""Price"":926.64,""SellerId"":45,""BuyerId"":33},{""Name"":""Air"",""Price"":331.53,""SellerId"":45,""BuyerId"":38},{""Name"":""Metoprolol Tartrate"",""Price"":1405.74,""SellerId"":21,""BuyerId"":49},{""Name"":""Pioglitazone"",""Price"":306.56,""SellerId"":23,""BuyerId"":36},{""Name"":""Butalbital, Aspirin and Caffeine"",""Price"":1010.98,""SellerId"":43,""BuyerId"":41},{""Name"":""Hydralazine Hydrochloride"",""Price"":1309.72,""SellerId"":45,""BuyerId"":null},{""Name"":""Nevirapine"",""Price"":1374.72,""SellerId"":38,""BuyerId"":31},{""Name"":""ESIKA"",""Price"":879.37,""SellerId"":16,""BuyerId"":24},{""Name"":""Homeopathic Rheumatism"",""Price"":967.08,""SellerId"":38,""BuyerId"":16},{""Name"":""Amitriptyline Hydrochloride"",""Price"":1453.96,""SellerId"":17,""BuyerId"":51},{""Name"":""Ibuprofen"",""Price"":1305.96,""SellerId"":5,""BuyerId"":10},{""Name"":""Laser Block 100"",""Price"":1135.43,""SellerId"":35,""BuyerId"":7},{""Name"":""ANXIETY/STRESS RELIEF"",""Price"":324.66,""SellerId"":56,""BuyerId"":43},{""Name"":""TYLENOL COLD MULTI-SYMPTOM DAYTIME"",""Price"":1010.81,""SellerId"":17,""BuyerId"":26},{""Name"":""Naproxen"",""Price"":807.22,""SellerId"":7,""BuyerId"":17},{""Name"":""Dover Aminophen"",""Price"":192.07,""SellerId"":15,""BuyerId"":null},{""Name"":""DIPYRIDAMOLE"",""Price"":1150.67,""SellerId"":24,""BuyerId"":1},{""Name"":""Etodolac"",""Price"":1443.13,""SellerId"":8,""BuyerId"":44},{""Name"":""ziprasidone hydrochloride"",""Price"":628.66,""SellerId"":38,""BuyerId"":5},{""Name"":""Treatment Set TS336667"",""Price"":1466.47,""SellerId"":52,""BuyerId"":35},{""Name"":""Prostate"",""Price"":716.05,""SellerId"":9,""BuyerId"":13},{""Name"":""Acid Reducer"",""Price"":1443.51,""SellerId"":25,""BuyerId"":43},{""Name"":""leader pain reliever"",""Price"":1179.79,""SellerId"":46,""BuyerId"":2},{""Name"":""allergy eye"",""Price"":426.91,""SellerId"":16,""BuyerId"":1},{""Name"":""Yellow Jacket hymenoptera venom Venomil Diagnostic"",""Price"":23.58,""SellerId"":22,""BuyerId"":3},{""Name"":""Acetaminophen, Chlorpheniramine Maleate, Dextromethorphan Hydrobromide, Phenylephrine Hydrochloride"",""Price"":1028.27,""SellerId"":50,""BuyerId"":null}]";

            var categoriesJson =
                @"[{""name"":""Drugs""},
               {""name"":""Adult""},
               {""name"":""Electronics""},
               {""name"":""Garden""},
               {""name"":""Weapons""},
               {""name"":""For Children""},
               {""name"":""Sports""},
               {""name"":""Fashion""},
               {""name"":""Autoparts""},
               {""name"":""Business""},
               {""name"":""Other""}]";

            var categoryProductsJson =
                @"[{""CategoryId"":4,""ProductId"":1},{""CategoryId"":11,""ProductId"":2},{""CategoryId"":6,""ProductId"":3},{""CategoryId"":5,""ProductId"":4},{""CategoryId"":4,""ProductId"":5},{""CategoryId"":11,""ProductId"":6},{""CategoryId"":5,""ProductId"":7},{""CategoryId"":8,""ProductId"":8},{""CategoryId"":8,""ProductId"":9},{""CategoryId"":5,""ProductId"":10},{""CategoryId"":5,""ProductId"":11},{""CategoryId"":5,""ProductId"":12},{""CategoryId"":5,""ProductId"":13},{""CategoryId"":9,""ProductId"":14},{""CategoryId"":6,""ProductId"":15},{""CategoryId"":4,""ProductId"":16},{""CategoryId"":6,""ProductId"":17},{""CategoryId"":5,""ProductId"":18},{""CategoryId"":7,""ProductId"":19},{""CategoryId"":1,""ProductId"":20},{""CategoryId"":4,""ProductId"":21},{""CategoryId"":2,""ProductId"":22},{""CategoryId"":10,""ProductId"":23},{""CategoryId"":2,""ProductId"":24},{""CategoryId"":10,""ProductId"":25},{""CategoryId"":5,""ProductId"":26},{""CategoryId"":6,""ProductId"":27},{""CategoryId"":2,""ProductId"":28},{""CategoryId"":8,""ProductId"":29},{""CategoryId"":7,""ProductId"":30},{""CategoryId"":2,""ProductId"":31},{""CategoryId"":4,""ProductId"":32},{""CategoryId"":4,""ProductId"":33},{""CategoryId"":1,""ProductId"":34},{""CategoryId"":3,""ProductId"":35},{""CategoryId"":1,""ProductId"":36},{""CategoryId"":2,""ProductId"":37},{""CategoryId"":5,""ProductId"":38},{""CategoryId"":11,""ProductId"":39},{""CategoryId"":7,""ProductId"":40},{""CategoryId"":9,""ProductId"":41},{""CategoryId"":2,""ProductId"":42},{""CategoryId"":7,""ProductId"":43},{""CategoryId"":4,""ProductId"":44},{""CategoryId"":10,""ProductId"":45},{""CategoryId"":7,""ProductId"":46},{""CategoryId"":2,""ProductId"":47},{""CategoryId"":2,""ProductId"":48},{""CategoryId"":3,""ProductId"":49},{""CategoryId"":4,""ProductId"":50},{""CategoryId"":10,""ProductId"":51},{""CategoryId"":9,""ProductId"":52},{""CategoryId"":8,""ProductId"":53},{""CategoryId"":11,""ProductId"":54},{""CategoryId"":11,""ProductId"":55},{""CategoryId"":11,""ProductId"":56},{""CategoryId"":10,""ProductId"":57},{""CategoryId"":2,""ProductId"":58},{""CategoryId"":4,""ProductId"":59},{""CategoryId"":8,""ProductId"":60},{""CategoryId"":2,""ProductId"":61},{""CategoryId"":1,""ProductId"":62},{""CategoryId"":9,""ProductId"":63},{""CategoryId"":10,""ProductId"":64},{""CategoryId"":1,""ProductId"":65},{""CategoryId"":9,""ProductId"":66},{""CategoryId"":10,""ProductId"":67},{""CategoryId"":1,""ProductId"":68},{""CategoryId"":4,""ProductId"":69},{""CategoryId"":3,""ProductId"":70},{""CategoryId"":11,""ProductId"":71},{""CategoryId"":10,""ProductId"":72},{""CategoryId"":3,""ProductId"":73},{""CategoryId"":8,""ProductId"":74},{""CategoryId"":1,""ProductId"":75},{""CategoryId"":10,""ProductId"":76},{""CategoryId"":4,""ProductId"":77},{""CategoryId"":4,""ProductId"":78},{""CategoryId"":11,""ProductId"":79},{""CategoryId"":11,""ProductId"":80},{""CategoryId"":11,""ProductId"":81},{""CategoryId"":2,""ProductId"":82},{""CategoryId"":8,""ProductId"":83},{""CategoryId"":1,""ProductId"":84},{""CategoryId"":5,""ProductId"":85},{""CategoryId"":2,""ProductId"":86},{""CategoryId"":4,""ProductId"":87},{""CategoryId"":1,""ProductId"":88},{""CategoryId"":10,""ProductId"":89},{""CategoryId"":11,""ProductId"":90},{""CategoryId"":10,""ProductId"":91},{""CategoryId"":8,""ProductId"":92},{""CategoryId"":9,""ProductId"":93},{""CategoryId"":1,""ProductId"":94},{""CategoryId"":3,""ProductId"":95},{""CategoryId"":5,""ProductId"":96},{""CategoryId"":2,""ProductId"":97},{""CategoryId"":5,""ProductId"":98},{""CategoryId"":1,""ProductId"":99},{""CategoryId"":9,""ProductId"":100},{""CategoryId"":5,""ProductId"":101},{""CategoryId"":9,""ProductId"":102},{""CategoryId"":7,""ProductId"":103},{""CategoryId"":8,""ProductId"":104},{""CategoryId"":1,""ProductId"":105},{""CategoryId"":8,""ProductId"":106},{""CategoryId"":4,""ProductId"":107},{""CategoryId"":8,""ProductId"":108},{""CategoryId"":8,""ProductId"":109},{""CategoryId"":9,""ProductId"":110},{""CategoryId"":5,""ProductId"":111},{""CategoryId"":4,""ProductId"":112},{""CategoryId"":10,""ProductId"":113},{""CategoryId"":1,""ProductId"":114},{""CategoryId"":5,""ProductId"":115},{""CategoryId"":9,""ProductId"":116},{""CategoryId"":2,""ProductId"":117},{""CategoryId"":5,""ProductId"":118},{""CategoryId"":2,""ProductId"":119},{""CategoryId"":7,""ProductId"":120},{""CategoryId"":3,""ProductId"":121},{""CategoryId"":7,""ProductId"":122},{""CategoryId"":11,""ProductId"":123},{""CategoryId"":1,""ProductId"":124},{""CategoryId"":1,""ProductId"":125},{""CategoryId"":11,""ProductId"":126},{""CategoryId"":9,""ProductId"":127},{""CategoryId"":10,""ProductId"":128},{""CategoryId"":3,""ProductId"":129},{""CategoryId"":4,""ProductId"":130},{""CategoryId"":6,""ProductId"":131},{""CategoryId"":7,""ProductId"":132},{""CategoryId"":11,""ProductId"":133},{""CategoryId"":10,""ProductId"":134},{""CategoryId"":4,""ProductId"":135},{""CategoryId"":11,""ProductId"":136},{""CategoryId"":3,""ProductId"":137},{""CategoryId"":8,""ProductId"":138},{""CategoryId"":9,""ProductId"":139},{""CategoryId"":6,""ProductId"":140},{""CategoryId"":7,""ProductId"":141},{""CategoryId"":4,""ProductId"":142},{""CategoryId"":1,""ProductId"":143},{""CategoryId"":9,""ProductId"":144},{""CategoryId"":4,""ProductId"":145},{""CategoryId"":4,""ProductId"":146},{""CategoryId"":6,""ProductId"":147},{""CategoryId"":6,""ProductId"":148},{""CategoryId"":4,""ProductId"":149},{""CategoryId"":2,""ProductId"":150},{""CategoryId"":1,""ProductId"":151},{""CategoryId"":5,""ProductId"":152},{""CategoryId"":1,""ProductId"":153},{""CategoryId"":2,""ProductId"":154},{""CategoryId"":4,""ProductId"":155},{""CategoryId"":7,""ProductId"":156},{""CategoryId"":7,""ProductId"":157},{""CategoryId"":3,""ProductId"":158},{""CategoryId"":5,""ProductId"":159},{""CategoryId"":9,""ProductId"":160},{""CategoryId"":8,""ProductId"":161},{""CategoryId"":2,""ProductId"":162},{""CategoryId"":2,""ProductId"":163},{""CategoryId"":1,""ProductId"":164},{""CategoryId"":1,""ProductId"":165},{""CategoryId"":6,""ProductId"":166},{""CategoryId"":1,""ProductId"":167},{""CategoryId"":9,""ProductId"":168},{""CategoryId"":6,""ProductId"":169},{""CategoryId"":3,""ProductId"":170},{""CategoryId"":3,""ProductId"":171},{""CategoryId"":2,""ProductId"":172},{""CategoryId"":5,""ProductId"":173},{""CategoryId"":5,""ProductId"":174},{""CategoryId"":9,""ProductId"":175},{""CategoryId"":7,""ProductId"":176},{""CategoryId"":3,""ProductId"":177},{""CategoryId"":10,""ProductId"":178},{""CategoryId"":6,""ProductId"":179},{""CategoryId"":5,""ProductId"":180},{""CategoryId"":2,""ProductId"":181},{""CategoryId"":11,""ProductId"":182},{""CategoryId"":3,""ProductId"":183},{""CategoryId"":10,""ProductId"":184},{""CategoryId"":11,""ProductId"":185},{""CategoryId"":10,""ProductId"":186},{""CategoryId"":3,""ProductId"":187},{""CategoryId"":7,""ProductId"":188},{""CategoryId"":4,""ProductId"":189},{""CategoryId"":5,""ProductId"":190},{""CategoryId"":1,""ProductId"":191},{""CategoryId"":9,""ProductId"":192},{""CategoryId"":11,""ProductId"":193},{""CategoryId"":8,""ProductId"":194},{""CategoryId"":6,""ProductId"":195},{""CategoryId"":2,""ProductId"":196},{""CategoryId"":11,""ProductId"":197},{""CategoryId"":8,""ProductId"":198},{""CategoryId"":6,""ProductId"":199},{""CategoryId"":6,""ProductId"":200}]";

            var products = JsonConvert.DeserializeObject<List<Product>>(productsJson);
            var categories = JsonConvert.DeserializeObject<List<Category>>(categoriesJson);
            var categoryProducts = JsonConvert.DeserializeObject<List<CategoryProduct>>(categoryProductsJson);

            context.Categories.AddRange(categories);
            context.Products.AddRange(products);
            context.CategoriesProducts.AddRange(categoryProducts);
            context.SaveChanges();
        }

        private static Type GetType(string modelName)
        {
            var modelType = CurrentAssembly
                .GetTypes()
                .FirstOrDefault(t => t.Name == modelName);

            Assert.IsNotNull(modelType, $"{modelName} model not found!");

            return modelType;
        }

        private static IServiceProvider ConfigureServices<TContext>(string databaseName)
            where TContext : DbContext
        {
            var services = ConfigureDbContext<TContext>(databaseName);

            var context = services.GetService<TContext>();

            try
            {
                context.Model.GetEntityTypes();
            }
            catch (InvalidOperationException ex) when (ex.Source == "Microsoft.EntityFrameworkCore.Proxies")
            {
                services = ConfigureDbContext<TContext>(databaseName, useLazyLoading: true);
            }

            return services;
        }

        private static IServiceProvider ConfigureDbContext<TContext>(string databaseName, bool useLazyLoading = false)
            where TContext : DbContext
        {
            var services = new ServiceCollection()
                 .AddDbContext<ProductShopContext>();

            var serviceProvider = services.BuildServiceProvider();
            return serviceProvider;
        }
    }
}
